{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Resources" : {
	"testec2" : {
	    "Type" : "AWS::EC2::Instance",
	    "Properties" : {
		"KeyName" : "laptop",
		"InstanceType": "t2.micro",
		"SecurityGroups" : [ { "Ref" : "testsg" } ],
		"ImageId" : "ami-9a562df2",
		"UserData" : {
		    "Fn::Base64" : {
			"Fn::Join" : ["",[
			    "wget --no-check-certificate https://raw.githubusercontent.com/bcwik9/ScriptsNStuff/master/setup_dev_server.sh && bash setup_dev_server.sh", "\n",
			    "/opt/aws/bin/cfn-signal -e 0 --stack ", { "Ref": "AWS::StackName" }, " --resource AutoScalingGroup\n"
			]]
		    }
		},
		"Tags": [
		    {
			"Key": "Name",
			"Value": "bentest"
		    },
		    {
			"Key": "branch_name",
			"Value": "master"
		    },
		    {
			"Key": "environment",
			"Value": "development"
		    },
		    {
			"Key": "db_type",
			"Value": "sqlite"
		    },
		    {
			"Key": "deployer",
			"Value": "ubuntu"
		    }

		]
	    }
	},

	"testsg" : {
	    "Type" : "AWS::EC2::SecurityGroup",
	    "Properties" : {
		"GroupDescription" : "Enable Access to Rails application via port 80, 443, 3000 and SSH access via port 22",
		"SecurityGroupIngress" : [ {
		    "IpProtocol" : "tcp",
		    "FromPort" : "22",
		    "ToPort" : "22",
		    "CidrIp" : "0.0.0.0/0"
		}, {
		    "IpProtocol" : "tcp",
		    "FromPort" : "3000",
		    "ToPort" : "3000",
		    "CidrIp" : "0.0.0.0/0"
		}, {
		    "IpProtocol" : "tcp",
		    "FromPort" : "80",
		    "ToPort" : "80",
		    "CidrIp" : "0.0.0.0/0"
		} , {
		    "IpProtocol" : "tcp",
		    "FromPort" : "443",
		    "ToPort" : "443",
		    "CidrIp" : "0.0.0.0/0"
		}],
		"Tags": [
		    {
			"Key": "Name",
			"Value": "bentest"
		    },
		    {
			"Key": "branch_name",
			"Value": "master"
		    },
		    {
			"Key": "environment",
			"Value": "development"
		    },
		    {
			"Key": "db_type",
			"Value": "sqlite"
		    },
		    {
			"Key": "deployer",
			"Value": "ubuntu"
		    }

		]
	    }
	},
	"CreationPolicy": {
	    "ResourceSignal": {
		"Timeout": "PT10M"
	    }
	},
    },

    "Outputs" : {
	"IP" : {
	    "Description" : "The IP for the newly created server",
	    "Value" : { "Fn::GetAtt" : [ "testec2", "PublicIp" ] } 
	},
	"WebsiteURL" : {
	    "Description" : "The URL for the newly created Rails application",
	    "Value" : { "Fn::Join" : ["", [ "http://", { "Fn::GetAtt" : [ "testec2", "PublicIp" ] } ]]}
	}
    }
}
